package me.nik.coffeeprotect.listeners;

import me.nik.coffeeprotect.CoffeeProtect;
import me.nik.coffeeprotect.api.events.PlayerExploitEvent;
import me.nik.coffeeprotect.enums.MsgType;
import me.nik.coffeeprotect.files.Config;
import me.nik.coffeeprotect.managers.logs.PlayerLog;
import me.nik.coffeeprotect.managers.profile.Profile;
import me.nik.coffeeprotect.utils.JsonBuilder;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;

public class ExploitListener implements Listener {

    private final CoffeeProtect plugin;

    public ExploitListener(CoffeeProtect plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    public void onExploit(PlayerExploitEvent e) {

        this.plugin.getAlertManager().getAlertExecutor().execute(() -> {

            Player player = e.getPlayer();

            if (!player.isOnline()) return;

            String checkName = e.getCheckName();

            String description = e.getDescription();

            String information = e.getInformation();

            String playerName = player.getName();

            int vl = e.getViolations();

            this.plugin.getLogManager().addLogToQueue(new PlayerLog(
                    Config.Setting.SERVER_NAME.getString(),
                    playerName,
                    player.getUniqueId().toString(),
                    checkName,
                    information
            ));

            //We're sending the alerts by using the server chat packet, Making this much more efficient.
            alerts:
            {

                String hoverMessage = MsgType.ALERT_HOVER.getMessage()
                        .replace("%description%", description)
                        .replace("%information%", information);

                String alertMessage = MsgType.ALERT_MESSAGE.getMessage()
                        .replace("%player%", playerName)
                        .replace("%check%", checkName)
                        .replace("%vl%", String.valueOf(vl));

                new JsonBuilder(alertMessage)
                        .setHoverEvent(JsonBuilder.HoverEventType.SHOW_TEXT, hoverMessage)
                        .setClickEvent(JsonBuilder.ClickEventType.RUN_COMMAND, "/tp " + playerName)
                        .buildText().sendMessage(this.plugin.getAlertManager().getPlayersWithAlerts());

                if (!Config.Setting.ALERT_CONSOLE.getBoolean()) break alerts;

                Bukkit.getConsoleSender().sendMessage(alertMessage);
            }
        });
    }
}